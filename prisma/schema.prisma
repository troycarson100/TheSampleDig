// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String        @id @default(cuid())
  email             String        @unique
  passwordHash      String        @map("password_hash")
  name              String?
  stripeCustomerId              String?    @map("stripe_customer_id")
  subscriptionStatus            String?    @map("subscription_status")
  subscriptionCurrentPeriodEnd  DateTime?  @map("subscription_current_period_end")
  createdAt                     DateTime   @default(now()) @map("created_at")
  savedSamples                  UserSample[]

  @@map("users")
}

model Channel {
  id          String   @id @default(cuid())
  channelId   String   @unique @map("channel_id")
  name        String
  reputation  Float    @default(0.5) // 0.0 = bad, 1.0 = good
  sampleCount Int      @default(0) @map("sample_count")
  skipCount   Int      @default(0) @map("skip_count")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  samples     Sample[]
  
  @@map("channels")
}

model Sample {
  id             String        @id @default(cuid())
  youtubeId      String        @unique @map("youtube_id")
  title          String
  channel        String
  channelId      String?       @map("channel_id")
  thumbnailUrl   String        @map("thumbnail_url")
  genre          String?
  era            String?
  bpm            Int?          @map("bpm")
  key            String?       @map("key")
  analysisStatus String?       @default("pending") @map("analysis_status")
  duration       Int?          @map("duration_seconds")
  qualityScore   Float?        @map("quality_score")
  source         String?       // "search" | "playlist" | "channel"
  tags           String?       // e.g. "post-5.5k" for samples added after 5.5k threshold
  embeddable     Boolean?       @map("embeddable") // false = blocked on external sites
  createdAt      DateTime      @default(now()) @map("created_at")
  userSamples    UserSample[]
  channelRel     Channel?      @relation(fields: [channelId], references: [id])

  @@map("samples")
}

model Candidate {
  id             String    @id @default(cuid())
  youtubeId      String    @unique @map("youtube_id")
  source         String    // "playlist" | "channel" | "manual"
  sourceId       String?   @map("source_id") // playlist ID or channel ID
  addedAt        DateTime  @default(now()) @map("added_at")
  title          String?
  description    String?   @db.Text
  channelId      String?   @map("channel_id")
  channelTitle   String?   @map("channel_title")
  thumbnailUrl   String?   @map("thumbnail_url")
  duration       Int?      @map("duration_seconds")
  tags           String?   @db.Text // JSON array as string
  publishedAt    DateTime? @map("published_at")
  enrichedAt     DateTime? @map("enriched_at")
  qualityScore   Float?    @map("quality_score")
  genre          String?
  era            String?
  embeddable     Boolean?  @map("embeddable") // false = uploader disabled embedding
  processedAt    DateTime? @map("processed_at")
  sampleId       String?   @map("sample_id") // set when promoted to Sample
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@map("candidates")
}

model UserSample {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  sampleId  String   @map("sample_id")
  startTime Int?     @map("start_time")
  notes     String?  // Chop points stored as JSON: [{ key, time, color, index }]
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  sample    Sample   @relation(fields: [sampleId], references: [id], onDelete: Cascade)

  @@unique([userId, sampleId])
  @@map("user_samples")
}
